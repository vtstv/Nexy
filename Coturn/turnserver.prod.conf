# Coturn TURN/STUN Server Configuration for Nexy Project - PRODUCTION
# ===========================================
# 
# IMPORTANT: Before using, set in docker-compose.prod.yml:
# - EXTERNAL_IP -> your server's real public IP
# - TURN_SECRET -> generate with: openssl rand -hex 32
#
# See docs/PRODUCTION_SETUP.md for full instructions
# ===========================================

# Listening port for STUN/TURN
listening-port=3478

# TLS listening port (for secure connections)
tls-listening-port=5349

# Listening IP address
listening-ip=0.0.0.0

# External IP address - REQUIRED for production
# Set via EXTERNAL_IP environment variable
external-ip=${EXTERNAL_IP}

# Relay IP address - let coturn bind to all interfaces
relay-ip=0.0.0.0

# Disable verbose logging in production (reduces CPU/memory usage)
# verbose

# Fingerprint in TURN messages
fingerprint

# Use long-term credentials mechanism with TIME-LIMITED tokens
lt-cred-mech
use-auth-secret
static-auth-secret=${TURN_SECRET}

# Stale nonce protection (prevents replay attacks)
stale-nonce=600

# Realm for authentication - set to your domain
realm=${TURN_REALM:-nexy.local}

# Deny loopback in production (SECURITY)
# allow-loopback-peers

# Deny peers from private IP ranges (SECURITY)
denied-peer-ip=10.0.0.0-10.255.255.255
denied-peer-ip=172.16.0.0-172.31.255.255
denied-peer-ip=192.168.0.0-192.168.255.255
denied-peer-ip=127.0.0.0-127.255.255.255
denied-peer-ip=0.0.0.0-0.255.255.255

# Deny multicast peers
no-multicast-peers

# Maximum bandwidth per allocation (1 Mbps - optimized for 1GB RAM server)
max-bps=1000000

# Total server bandwidth (50 Mbps - for ~30 concurrent calls)
bps-capacity=50000000

# Total allocation quota (limited for 1GB RAM)
total-quota=100

# User quota (max allocations per user)
user-quota=6

# Production relay port range
min-port=49152
max-port=65535

# Logging (use syslog to reduce disk I/O)
syslog

# Disable CLI (security)
no-cli

# Enable STUN
stun-only=false

# Run as non-root user (if not in Docker)
# proc-user=turnserver
# proc-group=turnserver

# TLS Certificate paths - REQUIRED for production
cert=/etc/coturn/certs/fullchain.pem
pkey=/etc/coturn/certs/privkey.pem

# Enable TLS in production
# no-tls
# no-dtls

# Cipher list for TLS
cipher-list="ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384"

# Server name
server-name=nexy-turn-prod

# WebRTC compatible settings
mobility

# Prometheus metrics (disabled for 1GB RAM server - saves ~50MB RAM)
# Enable only if you have monitoring infrastructure
# prometheus

# Secure stun (recommended for production)
secure-stun

# Session timeout (1 hour)
max-allocate-lifetime=3600

# Connection timeout (60 seconds)
max-allocate-timeout=60

# Database authentication (optional)
# Uncomment and configure for PostgreSQL-based user management
# psql-userdb="host=${DB_HOST} dbname=${DB_NAME} user=${DB_USER} password=${DB_PASSWORD}"

# Redis for session management (optional, for HA)
# redis-userdb="ip=${REDIS_HOST} port=${REDIS_PORT} dbname=0 password=${REDIS_PASSWORD} connect_timeout=30"
