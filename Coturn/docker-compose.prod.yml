services:
  coturn:
    image: coturn/coturn:latest
    container_name: nexy_coturn_prod
    restart: always
    
    # IMPORTANT: host network for better performance in production
    # If using host network, the ports: section is not needed
    # network_mode: host
    
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/udp"
      - "5349:5349/tcp"
      # Production: wider port range
      - "49152-65535:49152-65535/udp"
    
    volumes:
      - ./turnserver.prod.conf:/etc/coturn/turnserver.conf:ro
      - coturn_logs:/var/log
      # Let's Encrypt certificates
      # - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./certs:/etc/coturn/certs:ro
    
    environment:
      # REQUIRED: Set your server's public IP
      - EXTERNAL_IP=${EXTERNAL_IP}
      # REQUIRED: Secret for time-limited credentials (minimum 64 characters)
      # Generate with: openssl rand -hex 32
      - TURN_SECRET=${TURN_SECRET}
      # Optional: domain for realm
      - TURN_REALM=${TURN_REALM:-turn.nexy.app}
    
    command: ["-c", "/etc/coturn/turnserver.conf"]
    
    networks:
      - coturn_network
    
    # Resource limits for 1GB RAM / 1 CPU server
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 128M
    
    # Health check
    healthcheck:
      test: ["CMD", "turnutils_stunclient", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  coturn_logs:

networks:
  coturn_network:
    driver: bridge
